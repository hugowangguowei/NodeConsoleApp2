# Timeline UI 设计方案（ATB 风格技能节点）

> 本文仅描述 `timeline labeled-block` 的 UI/交互与渲染数据需求。
> Timeline 的运算/执行内核见：`design/timeline_design.md`。

---

## 1. 目标与对标

参考《仙剑奇侠传4》等 ATB 行动条的“直线时间轴 + 节点顺序”的可视化方式。

与传统 ATB（节点代表角色）不同：
- **节点代表技能（skill/action entry）**
- 展示的是“本回合行动序列”的先后顺序

用户价值：玩家在提交规划后即可直观看到“将按什么顺序放哪些技能”，并在推演阶段看到节点逐个被消费。

---

## 2. 整体布局

`timeline labeled-block` 建议结构分为三层：

1) **Header（信息 + 控制）**
- 回合号、阶段（READY/PLAYING/PAUSED/FINISHED/ERROR）
- 播放控制：开始 / 暂停 / 单步 / 倍速（1x/2x/4x）

2) **Bar（时间轴轨道 + 节点）**
- 一条横向轨道（track）
- 节点（skill bubbles）按顺序排列在轨道上

3) **Footer（日志/提示，可选）**
- 最近 N 条执行摘要（用于调试与验证）

> 注：如果后续要实现更接近 ATB 的“进度推进”，可以把节点放在轨道上动态移动；但 MVP 建议只做**顺序静态排布 + 当前高亮**。

---

## 3. 节点（Skill Bubble）视觉规范

每个节点表示一个 `TimelineEntry`。

### 3.1 外观
- 形状：**方形圆角气泡**（rounded square）
- 尺寸：相对当前实现缩减为 **0.5 倍**（长宽均减半）
- 内容：
  - 第一行：阵营标识（玩家/敌人）+ 技能名（短）
  - 第二行：可选数据，例如 `速度/状态`
- 图标：
  - 可选在左上角放一个小 icon（若未来有 `iconKey`）
- 锚点：节点底边中心增加一个**等腰三角锚点**，锚点尖端指向时间轴轨道，用于明确“该技能对应的轨道位置”

### 3.4 对齐规则（锚点对齐）
- 节点在视觉上不再以方形中心对齐轨道
- 采用“**三角锚点尖端**”作为几何对齐点
- 对齐基准：锚点尖端与轨道线重合，确保节点位置感知一致

### 3.2 状态色
- `PENDING`：中性紫/蓝边框
- `RUNNING`（当前执行）：高亮（金色描边/发光）
- `DONE`：偏绿色（完成态）
- `ERROR`：红色（失败态）

### 3.3 交互
- Hover：显示 tooltip（技能名/目标/部位等摘要）
- Click：
  - 高亮选中
  - 在 Footer 或侧栏输出该 entry 的详细信息（MVP 可先输出 console + battle log）

---

## 4. 轨道（Track）与节点布局规则

### 4.1 轨道对象抽象（速度标尺轴）

轨道不是纯装饰线，应抽象为“带标尺的速度轴”：

- 轴范围：`[-15, +15]`
- 中心刻度：`0`
- 左侧：负速度区（最小 `-15`）
- 右侧：正速度区（最大 `+15`）

建议渲染元素：
- **单一轴主线（baseline）**：节点锚点与该主线对齐；标尺刻度直接标注在同一条轴线附近（避免出现“两条线/脱节”）
- **刻度位置约束（避免与节点重叠）**：刻度数字应优先放在轴线**下方**（而非上方），从而避免与上方的技能节点/锚点产生遮挡
- 关键刻度：`-15, -10, -5, 0, +5, +10, +15`
- 可选次刻度（每 1 或 2）

### 4.1.1 UI 分层建议（Track 背景层 / Nodes 前景层）

为避免出现“刻度飘、两条线、滚动条意外出现、重绘时需要保留子树”等问题，建议将时间轴控件明确拆分为两层：

- **TrackLayer（背景层）**：负责轴线、渐变轨道、刻度、标尺标签等纯展示元素
- **NodeLayer（前景层）**：只负责渲染技能节点、状态色、高亮与交互

约束：
- baseline 仅由 TrackLayer 负责绘制一次（禁止 Nodes 容器再绘制“第二条线”）
- 刻度与 baseline 必须属于同一坐标系（同一容器/同一相对定位基准），避免视觉“脱节”
- NodeLayer 不应通过 `overflow-x: auto` 的滚动条来“兜底”解决碰撞或超出；超出应由控件自身策略处理（例如压缩、聚合、裁切提示）

说明（对应当前实现中暴露的问题类型）：
- **刻度飘**：当 baseline 用伪元素绘制、刻度用独立 DOM 绘制且 y 基准/padding 没有严格绑定时，即使“只有一条线”，也会出现刻度与线不贴合、随布局变化而漂移
- **横向滚动条离谱**：当节点采用绝对定位且同 speed 横向拍开会把节点推到容器可视区外，`overflow-x: auto` 会触发滚动条，这属于容器行为而非控件语义
- **清空/重绘时的补丁**：把刻度、轴线、节点塞入同一容器会导致每次刷新都需要“保留刻度子树”等维护性补丁；分层后可独立刷新 NodeLayer 而不影响 TrackLayer

### 4.2 运行与展示解耦（核心规则）

- **运行层**：保持离散固定频率（例如每 `0.3s/action`）
- **展示层**：节点位置按技能 `speed` 映射到速度轴，而不是简单按 index 均匀排布

即：执行顺序与播放节奏仍离散稳定；视觉位置表达“速度语义”。

### 4.3 速度映射公式（建议）

设轨道像素区间为 `[xMin, xMax]`，速度 `v ∈ [-15, 15]`：

`x = xMin + ((clamp(v, -15, 15) + 15) / 30) * (xMax - xMin)`

节点锚点尖端落在 `x` 位置。

### 4.4 重叠处理规则（速度优先 + 顺序拍开）

当两个或多个节点映射后发生重叠：

1) 基础定位始终按速度映射
2) 若检测到碰撞：
   - **同 speed（或映射到同一 x）**：按执行顺序在水平方向依次错开（横向拍开），保持“先后顺序可读”
   - **不同 speed 但仍重叠**：仍以速度位置为主，按执行顺序做最小水平错开，尽量不改变速度语义
3) 若无重叠，不做拍开，保持纯速度位置

说明：该策略满足“无重叠时按速度分布；重叠时按顺序可读”。

---

## 5. UI 与引擎的数据契约

UI 不直接读取 Engine 可变结构；只消费快照：
- `TimelineSnapshot.phase`
- `TimelineSnapshot.roundId`
- `TimelineSnapshot.currentIndex`
- `TimelineSnapshot.entries[]`（用于渲染节点）

建议 `entries` 里 UI 需要的字段：
- `entryId`
- `side`
- `skillId`
- `meta.label`（展示用标题）
- `meta.speed`（可选展示）
- `executionState`

事件驱动刷新：
- `TIMELINE_SNAPSHOT`
- `TIMELINE_ENTRY_START/END`
- `TIMELINE_READY/START/PAUSE/FINISHED/ERROR`

---

## 6. 与当前实现的对齐建议（工程侧）

当前已有：
- `script/ui/UI_TimelineBlock.js`：订阅事件并渲染列表

为了达到 ATB 风格，需要把渲染从“卡片列表”升级为：
- `timeline-list` 作为轨道容器
- `timeline-item` 按“气泡节点”风格渲染（正方形圆角）
- current/done/error 状态对应样式

实现建议：
- 保持 `UI_TimelineBlock` 的事件绑定不变
- 只改其 DOM 结构与 CSS（不影响 TimelineManager 内核）

---

## 7. 开放项

- 是否在节点上显示“目标部位/目标对象”？（信息密度 vs 清晰度）
- 节点过多时采用滚动还是压缩（缩小节点/折叠）
- 是否允许点击节点跳转播放指针（需要 Timeline 支持 seek）

