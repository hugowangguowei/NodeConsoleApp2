# 技能编辑器设计文档 (Skill Editor Design)

## 1. 概述 (Overview)

为了满足日益复杂的技能系统设计需求，特别是技能树结构的可视化编辑，我们需要开发一款基于网页的 **技能编辑器 (Skill Editor)**。该编辑器将允许开发者在一个可视化的二维画布上创建、编辑、连接和管理技能节点，并最终将数据导出为游戏引擎可用的 JSON 格式。

核心目标：
*   **可视化编辑**：脱离纯文本编辑，通过节点连线直观地构建技能树。
*   **高效管理**：支持技能的增删改查，以及流派、稀有度的快速筛选。
*   **数据一致性**：确保导出的数据符合游戏引擎 `DataManager` 的数据结构规范。

---

## 2. 编辑器功能 (Editor Capabilities)

### 2.1 技能管理
*   **载入文件**：支持从本地或远程加载技能 JSON 文件。加载完成的数据将以图谱形式展示在画布上。
*   **创建技能**：支持通过工具栏新建技能节点。
*   **编辑属性**：选中节点后，在侧边栏编辑技能的详细属性（名称、ID、AP消耗、稀有度、效果描述、伤害倍率等）。
*   **删除技能**：支持删除选中的节点（智能处理前置/后置关系的解绑）。
*   **复制/粘贴**：快速复制已有技能配置，便于制作同流派的进阶技能。

### 2.2 技能树构建 (核心功能)
*   **节点拖拽**：在二维画布上自由拖拽技能节点，调整布局。
*   **连线关系**：通过从一个节点拖拽连线到另一个节点，建立 **前置依赖 (Prerequisite)** 关系。
    *   箭头的方向表示依赖方向（例如：`重锤挥击` -> `野蛮冲撞` 表示 `重锤挥击` 是 `野蛮冲撞` 的前置）。
*   **关系解除**：选中连线并删除，解除依赖关系。
*   **自动布局验证**：检测是否存在循环依赖（虽然DAG通常不允许环，但编辑器应给予提示）。

### 2.3 数据输入/输出 (I/O)
*   **导入 JSON**：支持上传或粘贴现有的 `skills.json` 内容，还原为图谱结构。
*   **导出 JSON**：一键生成符合游戏定义的 `skills.json` 数据结构，供开发者直接复制或下载。
*   **本地缓存**：利用 `localStorage` 自动保存当前编辑进度，防止意外丢失。

---

## 3. 编辑器实现形式 (Implementation)

### 3.1 技术方案选型 (Technical Architecture)
为了满足网格对齐和正交折线的需求，建议采用 **分层渲染 (Layered Rendering)** 架构：

*   **Layer 1 (Bottom): 背景网格层 (Canvas)**
    *   使用 HTML5 Canvas 绘制静态网格线。
    *   **理由**: Canvas 绘制大量简单线条性能极佳，且作为背景无需交互，适合处理无限画布的视觉参考。
*   **Layer 2 (Middle): 连线层 (SVG)**
    *   使用全屏 SVG 覆盖在 Canvas 之上。
    *   **连线对象**: 使用 `<polyline>` 或 `<path>` 元素绘制折线。
    *   **理由**: SVG 元素是 DOM 的一部分，原生支持事件监听（如 `click` 选中连线、`hover` 高亮），这比在 Canvas 中手动实现点击检测要简单得多。
    *   **路由算法**: 不需要引入重型库，只需实现一个简易的 **Manhattan Routing** (曼哈顿路由) 算法，确保线条只在 `Grid Lines` 上行走。
*   **Layer 3 (Top): 节点交互层 (HTML DOM)**
    *   使用 `absolute` 定位的 `div` 元素表示技能节点。
    *   **理由**: 节点包含复杂的文本、图标和边框样式，HTML+CSS 是实现这些最灵活且开发成本最低的方式。
*   **辅助库**: 
    *   不建议使用大型图表库。推荐 **原生实现**，以保证对“网格吸附”和“正交走线”逻辑的绝对控制。

### 3.2 界面布局 (UI Layout)

编辑器界面分为四个主要区域：

#### A. 顶部工具栏 (Toolbar)
*   **文件操作**：[导入 JSON] [导出 JSON] [清空画布]
*   **视图操作**：[重置缩放] [自动排列(可选)]
*   **流派筛选**：下拉菜单选择当前显示的流派（例如：只显示“重装猛攻”），避免画布过于杂乱。

#### B. 技能列表 (SkillList)
*   左侧停靠面板，显示当前加载的所有技能列表。
*   支持搜索过滤。
*   支持拖拽技能到画布上（如果技能未在画布上）。

#### C. 中央画布区 (Canvas Workspace) - 核心设计
为了更好地支持技能树的可视化编辑，该区域采用 **基于网格的混合渲染 (Grid-based Hybrid Rendering)** 方案。

1.  **要素组成 (Composition)**
    *   **背景网格 (Background Grid)**: 画布被划分为 `M * N` 的虚拟网格区域（例如 100x100px 单元格）。
        *   **功能**: 对齐辅助，每个网格单元 (Cell) 作为一个布局插槽，通常只能容纳一个技能节点。
        *   **实现**: 使用 HTML5 Canvas 绘制浅色线条，随缩放和平移更新。
    *   **技能节点 (Skill Nodes)**: 浮动在网格之上的 DOM 元素。
        *   **功能**: 显示技能图标、名称、ID 和消耗。
        *   **对齐**: 拖拽释放时，节点会自动吸附 (Snap) 到最近的网格单元中心。
        *   **端口**: 实际上节点不显示显式的端口，但在逻辑上，每个单元格的四条边中点因为连线机制而成为潜在的连接点。
    *   **技能连线 (Skill Connections)**: 表示 `前置 -> 后续` 的依赖关系。
        *   **视觉**: 带有箭头的折线 (Polylines)。
        *   **方向**: 有向图，箭头指向依赖此技能的后续技能（或者反过来，视编辑器逻辑，通常 Parent -> Child）。

2.  **连线绘制技术 (Routing Strategy)**
    *   **正交路由 (Orthogonal Routing)**: 连线必须是水平或垂直的折线，禁止斜线。
    *   **边缘行走 (Channel Routing)**: 连线沿着网格线（即单元格的边缘）绘制，而不是穿过单元格内部。
        *   这样可以避免连线横穿技能节点，保证视觉清晰。
    *   **连接点 (Anchor Points)**: 每个网格单元的 **上、右、下、左** 四个边的中点是合法的连线出入口。
        *   连线算法会自动寻找最近的路径（例如简化的 Manhattan Pathfinding），从源节点的某一侧出来，沿着网格线走到目标节点的某一侧进入。

#### D. 右侧属性面板 (Properties Panel)
*   **基本信息**：
    *   `ID` (自动生成或手动指定)
    *   `Name` (技能名称)
    *   `Type` (下拉选择：Active/Passive/Buff)
    *   `School` (下拉选择：Melee/Ranged/Magic)
    *   `SubClass` (下拉选择：Juggernaut/Guardian/etc.)
*   **数值配置**：
    *   `Rarity` (1-5 / Common-Legendary)
    *   `AP Cost` (数字输入)
    *   `Cooldown` (数字输入)
*   **效果配置**：
    *   `Description` (文本域，支持模板变量如 `{damage}`)
    *   `Effects` (JSON 数组编辑器，或者简化的 Key-Value 列表，用于定义伤害类型、数值、Buff ID 等)。
*   **关系显示**：
    *   只读显示 `Pre-requisite ID` (由画布连线自动生成，此处仅作展示)。

---

## 4. 关键交互设计 (Interaction Design)

### 4.1 节点连线逻辑 (Connection Logic)
1.  **触发连线**: 
    *   鼠标悬停在技能节点（或其边缘）时，显示四个方向的 **连接锚点 (Anchor)** (半透明圆点)。
    *   从任一锚点按下鼠标左键开始拖拽。
2.  **拖拽过程**:
    *   显示一条跟随鼠标的虚线（此时可以是直线，作为预览）。
    *   鼠标经过其他节点的可连接锚点时，锚点高亮吸附。
3.  **建立连接**:
    *   在目标锚点释放鼠标。
    *   **系统计算路径**: 根据起点和终点的网格坐标，计算一条沿着网格线的正交路径 (Manhattan Path)。
    *   **数据更新**: 将连接关系写入数据模型（`preRequisite` 字段）。
4.  **删除连接**:
    *   选中连线（高亮），按 Delete 键删除。
    *   或右键与连线交互进行删除。

### 4.2 节点样式的动态化
*   **稀有度着色**：节点的头部颜色根据稀有度字段（Common: 灰, Uncommon: 绿, Rare: 蓝, Epic: 紫, Legendary: 金）自动变化，方便直观查看分布。
*   **流派分组**：不同流派的节点背景色或图标略有不同。

### 4.3 批量操作
*   框选多个节点，进行整体移动。
*   按住 Shift 点击多选。

---

## 5. 数据结构规范 (Data Structure Schema)

编辑器导出的 JSON 应当是一个对象数组，每个对象代表一个技能。

```json
[
  {
    "id": "skill_melee_001",
    "name": "重锤挥击",
    "icon": "icon_bash.png",
    "school": "melee",
    "subClass": "juggernaut",
    "rarity": "common", // 或 tier: 1
    "apCost": 3,
    "cooldown": 0,
    "description": "对选中部位造成 120% 物理伤害。",
    "preRequisite": null, // 无前置
    "effects": [
      {
        "type": "damage_physical",
        "value": 1.2,
        "target": "selected_part"
      }
    ],
    "editorMeta": { // 编辑器专用元数据，导出给游戏引擎时通过构建脚本剔除，或者保留也无妨
       "x": 100,
       "y": 200
    }
  },
  {
    "id": "skill_melee_004",
    "name": "野蛮冲撞",
    "preRequisite": "skill_melee_001", // 关联 ID
    // ... 其他属性
    "editorMeta": {
       "x": 100,
       "y": 400
    }
  }
]
```

**关于 `editorMeta`**：
为了保证下次打开编辑器时节点位置不变，我们需要在 JSON 中保存节点的 `x, y` 坐标。
*   **方案 A**：直接保存在技能对象中。优点是实现简单，缺点是污染了游戏数据（虽然影响很小）。
*   **方案 B**：保存为单独的 `skill_layout.json`。优点是数据纯净，缺点是维护两个文件麻烦。
*   **建议**：采用方案 A。在游戏引擎加载时忽略 `editorMeta` 字段即可。

---

## 6. 开发路线图 (Roadmap)

1.  **Phase 1: 基础原型**
    *   搭建 HTML 布局 (Left Canvas + Right Panel)。
    *   实现节点的 DOM 渲染。
    *   实现拖拽移动功能。
    *   实现属性面板的双向绑定。

2.  **Phase 2: 连线与关系**
    *   实现 SVG 连线绘制。
    *   实现拖拽创建连线。
    *   实现数据层面的父子关系绑定。

3.  **Phase 3: 数据导入导出**
    *   完成 JSON 解析与生成逻辑。
    *   实现 LocalStorage 自动保存。
    *   添加稀有度颜色等视觉优化。

4.  **Phase 4: 整合**
    *   将生成的 `skills.json` 放入 `assets/data/` 并在游戏中测试加载。
