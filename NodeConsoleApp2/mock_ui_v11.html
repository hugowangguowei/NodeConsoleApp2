<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>网页回合制战斗系统 Demo V7 (Battle Row Test)</title>
<link rel="stylesheet" href="mock_ui_v11.css">
</head>
<body>
<div class="app-shell">
<div id="uiAttentionBadge" class="ui-attention-badge" aria-live="polite">阶段：IDLE</div>
<main>
  <section class="scene-wrapper labeled-block">
    <div class="area-tag">场景区</div>
    <section class="timeline labeled-block">
      <div class="sub-area-tag" style="display:none;">行动顺序区域</div>
      <div class="timeline-head">
        <div class="timeline-meta">
          <span id="timelineRoundLabel">回合 -</span>
          <span id="timelinePhaseLabel">IDLE</span>
        </div>
        <div class="timeline-controls">
          <button type="button" id="timelineStartBtn">开始</button>
          <button type="button" id="timelineStepBtn">单步</button>
          <select id="timelineSpeedSelect">
            <option value="1x" selected>1x</option>
            <option value="2x">2x</option>
            <option value="4x">4x</option>
          </select>
          <button type="button" id="timelineFinishBtn">直接结算</button>
        </div>
      </div>
      <div class="timeline-track" id="timelineTrack">
        <div class="timeline-track-layer" id="timelineTrackLayer" aria-hidden="true"></div>
        <div class="timeline-node-layer" id="timelineNodeLayer"></div>
      </div>
      <ul class="timeline-log-list" id="timelineLogList"></ul>
    </section>
    <div class="battle-row">
      <section class="hud-panel player-hud labeled-block">
      <h2>玩家：王国骑士</h2>
      <div class="hud-stat">
        <span>HP 120 / 150</span>
        <div class="bar hp"><span></span></div>
      </div>
      <div class="hud-stat">
        <span>行动力（AP） 4 / 6</span>
        <div class="bar ap"><span></span></div>
      </div>
      <div class="status-row">
         <span class="status-label">BUFF</span>
         <div class="status-icons">
           <div class="status-icon buff" data-name="圣光护盾" data-desc="受击时减免20%伤害"></div>
         </div>
       </div>

<!-- Skill Tree Overlay (方案B：独立大窗，不复用 System Modal) -->
<div id="skillTreeOverlay" class="overlay-backdrop" aria-hidden="true">
  <div class="overlay-panel" role="dialog" aria-modal="true" aria-label="技能树">
    <div class="overlay-header">
      <div class="overlay-title">技能树</div>
      <button class="overlay-close-btn" id="skillTreeCloseBtn" type="button">×</button>
    </div>
    <div class="overlay-body" id="skillTreeBody"></div>
  </div>
</div>
       <div class="status-row">
         <span class="status-label">DEBUFF</span>
         <div class="status-icons">
           <div class="status-icon neutral" data-name="无减益" data-desc="当前无异常状态"></div>
         </div>
       </div>
       <div class="armor-list-wrapper">
        <div class="armor-row" data-key="head">
          <span class="armor-name">头部</span>
          <div class="armor-bar"><span style="width:50%"></span></div>
          <span class="armor-value">30 / 30</span>
        </div>
        <div class="armor-row" data-key="chest">
          <span class="armor-name">胸部</span>
          <div class="armor-bar"><span style="width:75%"></span></div>
          <span class="armor-value">45 / 60</span>
        </div>
        <div class="armor-row" data-key="abdomen">
          <span class="armor-name">腹部</span>
          <div class="armor-bar"><span style="width:58.3%"></span></div>
          <span class="armor-value">35 / 50</span>
        </div>
        <div class="armor-row" data-key="arm">
          <span class="armor-name">手部</span>
          <div class="armor-bar"><span style="width:50%"></span></div>
          <span class="armor-value">30 / 60</span>
        </div>
        <div class="armor-row" data-key="leg">
          <span class="armor-name">腿部</span>
          <div class="armor-bar"><span style="width:35%"></span></div>
          <span class="armor-value">21 / 60</span>
        </div>
       </div>
       </section>
      <section class="battle-scene labeled-block">
        <div class="sub-area-tag">战斗场景区域</div>
        
        <!-- 1. 背景层 (Stage Background) -->
        <div class="stage-background">
          <!-- 可选：远景、中景、近景地板 -->
          <div class="stage-sky"></div>
          <div class="stage-floor"></div>
        </div>
        
        <!-- 2. 角色层 (Fighters Layer) -->
        <div class="fighters-layer">
          <!-- 玩家角色 -->
          <div class="fighter player-character">
            <!-- 角色容器：支持分层换装 -->
            <div class="character-sprite-container">
               <div class="sprite-layer body"></div>   <!-- 素体 -->
               <div class="sprite-layer armor"></div>  <!-- 护甲 -->
               <div class="sprite-layer weapon"></div> <!-- 武器 -->
            </div>
            <div class="character-shadow"></div> <!-- 脚底阴影 -->
            <div class="effect-anchor"></div>    <!-- 特效挂载点 -->
          </div>
          
          <!-- 敌方角色 -->
          <div class="fighter enemy-character">
            <div class="character-sprite-container">
               <div class="sprite-layer body"></div>
               <div class="sprite-layer armor"></div>
               <div class="sprite-layer weapon"></div>
            </div>
            <div class="character-shadow"></div>
            <div class="effect-anchor"></div>
          </div>
        </div>
        
        <!-- 3. 特效层 (FX Layer) -->
        <div class="fx-layer">
          <!-- 用于播放打击火花、伤害数字等 -->
        </div>
      </section>
      <section class="hud-panel enemy-hud labeled-block">
      <h2>敌人：暗影刺客</h2>
      <div class="hud-stat">
        <span>HP 80 / 120</span>
        <div class="bar hp"><span style="width:65%"></span></div>
      </div>
      <div class="hud-stat">
        <span>行动力（AP） 3 / 5</span>
        <div class="bar ap"><span style="width:60%"></span></div>
      </div>
      <div class="status-row">
         <span class="status-label">BUFF</span>
         <div class="status-icons">
           <div class="status-icon buff" data-name="暗影潜行" data-desc="闪避提升15%"></div>
         </div>
       </div>
       <div class="status-row">
         <span class="status-label">DEBUFF</span>
         <div class="status-icons">
           <div class="status-icon debuff" data-name="流血" data-desc="每回合 -8 HP"></div>
         </div>
       </div>
       <div class="armor-list-wrapper">
        <div class="armor-row" data-key="head">
          <span class="armor-name">头部</span>
          <div class="armor-bar"><span style="width:30%"></span></div>
          <span class="armor-value">15 / 30</span>
        </div>
        <div class="armor-row" data-key="chest">
          <span class="armor-name">胸部</span>
          <div class="armor-bar"><span style="width:20%"></span></div>
          <span class="armor-value">10 / 50</span>
        </div>
        <div class="armor-row" data-key="abdomen">
          <span class="armor-name">腹部</span>
          <div class="armor-bar"><span style="width:36%"></span></div>
          <span class="armor-value">18 / 40</span>
        </div>
        <div class="armor-row" data-key="arm">
          <span class="armor-name">手部</span>
          <div class="armor-bar"><span style="width:20%"></span></div>
          <span class="armor-value">20 / 100</span>
        </div>
        <div class="armor-row" data-key="leg">
          <span class="armor-name">腿部</span>
          <div class="armor-bar"><span style="width:52%"></span></div>
          <span class="armor-value">52 / 100</span>
        </div>
       </div>
        </section>
    </div>
  </section>

  <section class="action-panel labeled-block">
    <div class="area-tag">技能操作区域</div>
    <div class="skill-panel skill-deck-layout">
      <!-- 1. Left Column: Skill Pool (技能库) -->
      <div class="skill-pool-column">
        <div class="ap-meter" id="apMeter" aria-label="行动力（AP）" role="group">
          <div class="ap-meter__label">行动力（AP）</div>
          <div class="ap-meter__slots" id="apMeterSlots" aria-hidden="true"></div>
          <div class="ap-meter__value" id="apMeterValue">- / -</div>
        </div>
        <div class="skill-grid-view" id="skillList">
          <button type="button" class="skill-icon-button rarity-common type-offense active" data-name="重斩" data-type="近战技能" data-cost="AP 2" data-speed="速度 +1" data-target="命中部位：躯干" data-effect="对目标造成 150% 物理伤害。" data-tags="单体,物理" data-tip="基础的高伤害技能" data-sort-cost="2" data-sort-target="single">
            <span class="skill-badge-ap">2</span>
            <span class="skill-icon-center">⚔️</span>
            <span class="skill-name-bar">重斩</span>
          </button>
          <button type="button" class="skill-icon-button rarity-rare type-offense" data-name="火球术" data-type="魔法技能" data-cost="AP 3" data-speed="速度 -1" data-target="命中部位：全身" data-effect="造成 120% 火焰伤害，并附加燃烧效果。" data-tags="魔法,燃烧" data-tip="对高护甲单位有效" data-sort-cost="3" data-sort-target="single">
            <span class="skill-badge-ap">3</span>
            <span class="skill-icon-center">🔥</span>
            <span class="skill-name-bar">火球术</span>
          </button>
          <button type="button" class="skill-icon-button rarity-uncommon type-defense" data-name="治愈之光" data-type="神圣技能" data-cost="AP 2" data-speed="速度 0" data-target="效果：恢复生命" data-effect="为友方单位恢复 40 点生命值。" data-tags="治疗,神圣" data-tip="保持队伍生存" data-sort-cost="2" data-sort-target="ally">
            <span class="skill-badge-ap">2</span>
            <span class="skill-icon-center">✨</span>
            <span class="skill-name-bar">治愈之光</span>
          </button>
          <button type="button" class="skill-icon-button rarity-epic type-offense" data-name="雷击" data-type="魔法技能" data-cost="AP 4" data-speed="速度 -2" data-target="命中部位：头部" data-effect="造成 200% 雷电伤害，有几率眩晕目标。" data-tags="魔法,控制" data-tip="高消耗高回报" data-sort-cost="4" data-sort-target="single">
            <span class="skill-badge-ap">4</span>
            <span class="skill-icon-center">⚡</span>
            <span class="skill-name-bar">雷击</span>
          </button>
          <button type="button" class="skill-icon-button rarity-legendary type-offense" data-name="陨石术" data-type="魔法技能" data-cost="AP 6" data-speed="速度 -5" data-target="命中部位：群体" data-effect="召唤陨石，造成 300% 毁灭性伤害。" data-tags="魔法,终极" data-tip="消耗巨大但威力惊人" data-sort-cost="6" data-sort-target="aoe">
            <span class="skill-badge-ap">6</span>
            <span class="skill-icon-center">☄️</span>
            <span class="skill-name-bar">陨石术</span>
          </button>
          <button type="button" class="skill-icon-button rarity-common type-defense disabled" data-name="钢铁防御" data-type="防御技能" data-cost="AP 1" data-speed="速度 +2" data-target="效果：提升护甲" data-effect="获得 20 点临时护甲，持续 1 回合。" data-tags="防御,护甲" data-tip="预判敌方攻击时使用" data-sort-cost="1" data-sort-target="self">
            <span class="skill-badge-ap">1</span>
            <span class="skill-icon-center">🛡️</span>
            <span class="skill-name-bar">钢铁防御</span>
          </button>
        </div>
        <div class="skill-sort-bar">
          <button type="button" class="sort-btn" id="btnOpenSkillTree">打开技能树</button>
        </div>
      </div>

      <!-- 2. Center Column: Action Matrix (待执行队列) -->
      <div class="action-matrix-column">
        <div class="action-matrix-container">

<!-- Timeline TrackLayer config is imported by `UI_TimelineBlock` directly (方案B)。 -->
          <!-- Row 1: Head (头部) -->
          <div class="matrix-row" data-row-part="head">
            <div class="matrix-zone self-zone">
              <div class="slot-placeholder" data-part="head" data-target-type="self"></div>
            </div>
            <div class="matrix-label">头部</div>
            <div class="matrix-zone enemy-zone">
              <div class="slot-placeholder" data-part="head" data-target-type="enemy"></div>
              <div class="slot-placeholder" data-part="head" data-target-type="enemy"></div>
              <div class="slot-placeholder" data-part="head" data-target-type="enemy"></div>
            </div>
          </div>
          <!-- Row 2: Chest (胸部) -->
          <div class="matrix-row" data-row-part="chest">
            <div class="matrix-zone self-zone">
              <div class="slot-placeholder" data-part="chest" data-target-type="self"></div>
            </div>
            <div class="matrix-label">胸部</div>
            <div class="matrix-zone enemy-zone">
              <div class="slot-placeholder" data-part="chest" data-target-type="enemy"></div>
              <div class="slot-placeholder" data-part="chest" data-target-type="enemy"></div>
              <div class="slot-placeholder" data-part="chest" data-target-type="enemy"></div>
            </div>
          </div>
          <!-- Row 3: Abdomen (腹部) -->
          <div class="matrix-row" data-row-part="abdomen">
            <div class="matrix-zone self-zone">
              <div class="slot-placeholder" data-part="abdomen" data-target-type="self"></div>
            </div>
            <div class="matrix-label">腹部</div>
            <div class="matrix-zone enemy-zone">
              <div class="slot-placeholder" data-part="abdomen" data-target-type="enemy"></div>
              <div class="slot-placeholder" data-part="abdomen" data-target-type="enemy"></div>
              <div class="slot-placeholder" data-part="abdomen" data-target-type="enemy"></div>
            </div>
          </div>
          <!-- Row 4: Arm (手部) -->
          <div class="matrix-row" data-row-part="arm">
             <div class="matrix-zone self-zone">
               <div class="slot-placeholder" data-part="arm" data-target-type="self"></div>
             </div>
             <div class="matrix-label">手部</div>
             <div class="matrix-zone enemy-zone">
               <div class="slot-placeholder" data-part="arm" data-target-type="enemy"></div>
               <div class="slot-placeholder" data-part="arm" data-target-type="enemy"></div>
               <div class="slot-placeholder" data-part="arm" data-target-type="enemy"></div>
             </div>
          </div>
          <!-- Row 5: Leg (腿部) -->
          <div class="matrix-row" data-row-part="leg">
             <div class="matrix-zone self-zone">
               <div class="slot-placeholder" data-part="leg" data-target-type="self"></div>
             </div>
             <div class="matrix-label">腿部</div>
             <div class="matrix-zone enemy-zone">
               <div class="slot-placeholder" data-part="leg" data-target-type="enemy"></div>
               <div class="slot-placeholder" data-part="leg" data-target-type="enemy"></div>
               <div class="slot-placeholder" data-part="leg" data-target-type="enemy"></div>
             </div>
          </div>
          <!-- Row 6: Global/Other (全身/通用) -->
           <div class="matrix-row" data-row-part="global">
            <div class="matrix-zone self-zone">
              <div class="slot-placeholder" data-part="global" data-target-type="self"></div>
            </div>
            <div class="matrix-label">通用</div>
            <div class="matrix-zone enemy-zone">
              <div class="slot-placeholder" data-part="global" data-target-type="enemy"></div>
              <div class="slot-placeholder" data-part="global" data-target-type="enemy"></div>
              <div class="slot-placeholder" data-part="global" data-target-type="enemy"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- 3. Right Column: Detail (详情) -->
      <div class="skill-detail-column">
        <section class="skill-detail compact-detail" id="skillDetail">
          <h4 id="detailName">重斩</h4>
          <div class="detail-meta" id="detailMeta">近战技能 · AP 2 · 速度 +1</div>
          <p class="detail-body" id="detailEffect"><strong>效果</strong>：对目标造成 150% 物理伤害。</p>
          <p class="detail-body" id="detailTarget"><strong>范围</strong>：躯干。</p>
          <p class="detail-body" id="detailCosts"><strong>消耗</strong>：-</p>
          <p class="detail-body" id="detailSpeed"><strong>速度</strong>：-</p>
          <p class="detail-body" id="detailBuffs"><strong>Buff</strong>：-</p>
          <p class="detail-body" id="detailTip"><strong>提示</strong>：基础高伤。</p>
          <div class="detail-tags" id="detailTags">
            <span>单体</span>
            <span>物理</span>
          </div>
        </section>
      </div>
    </div>
    <aside class="turn-panel">
      <h4>回合控制</h4>
      <div class="turn-panel-meta">
        <span class="turn-panel-meta__label">当前回合</span>
        <span class="turn-panel-meta__value" id="turnNumberLabel">-</span>
      </div>
      <div class="turn-buttons">
        <button type="button" class="turn-button primary" id="btnExecute">执行</button>
        <button type="button" class="turn-button secondary" id="btnReset">重置</button>
        <button type="button" class="turn-button neutral" id="btnMenu">设置</button>
      </div>
    </aside>
   </section>
</main>
<footer>示意图仅供策划沟通，最终表现由 UI / 美术进一步设计。</footer>

<button class="system-menu-btn" id="systemMenuBtn">⚙️</button>

<div id="systemModal" class="modal-backdrop">
  <div class="modal-panel">
    <header class="modal-header">
      <h3 class="modal-title" id="modalTitle">系统菜单</h3>
      <button class="modal-close-btn" id="modalCloseBtn">×</button>
    </header>
    <div class="modal-body" id="modalBody">
      <!-- Dynamic Content -->
    </div>
    <footer class="modal-footer" id="modalFooter">
      <!-- Dynamic Actions -->
    </footer>
  </div>
</div>

</div>
<script>
  window.DATA_CONFIG_URL = '../assets/data/config.json';
</script>
<script type="module">
        import { CoreEngine } from '../script/engine/CoreEngine.js';
        import { UI_BattleRow } from '../script/ui/UI_BattleRow.js';
        import { UI_SystemModal } from '../script/ui/UI_SystemModal.js';
        import UI_SkillPanel from '../script/ui/UI_SkillPanel.js';
        import UI_TurnPanel from '../script/ui/UI_TurnPanel.js';
        import { UI_TimelineBlock } from '../script/ui/UI_TimelineBlock.js';
        import { UI_AttentionGuide } from '../script/ui/UI_AttentionGuide.js';

        // Initialize Engine
        const engine = new CoreEngine();
        
        // Expose to window for debugging
        window.GameEngine = engine;

        // Initialize UI Components
        const uiBattleRow = new UI_BattleRow();
        const uiSystemModal = new UI_SystemModal();
        const uiSkillPanel = new UI_SkillPanel(engine); // Constructor injection
        const uiTurnPanel = new UI_TurnPanel(engine);
        const uiTimelineBlock = new UI_TimelineBlock(engine);
        const uiAttentionGuide = new UI_AttentionGuide(engine);

        // Bind UI to Engine
        uiBattleRow.init(engine);
        // uiSystemModal.init(engine) covers binding. 
        // uiSystemModal.bind(engine); <-- Removed incorrect call
        
        // Use standard init()
        if (uiSystemModal.init) uiSystemModal.init(engine);

        // Skill Tree button
        const btnOpenSkillTree = document.getElementById('btnOpenSkillTree');
        if (btnOpenSkillTree) {
            btnOpenSkillTree.addEventListener('click', () => {
                if (engine && engine.eventBus) {
                    engine.eventBus.emit('UI:OPEN_SKILL_TREE', {});
                }
            });
        }

        // Hook overlay UI implementation
        import { UI_SkillTreeOverlay } from '../script/ui/UI_SkillTreeOverlay.js';
        const uiSkillTreeOverlay = new UI_SkillTreeOverlay();
        uiSkillTreeOverlay.init(engine);

        console.log('UI System Initialized');

        // Start Game (triggered by engine auto-init usually, or manual)
        // CoreEngine constructor calls init() -> fsm.changeState('INIT') -> 'LOGIN'
    </script>
</body>
</html>
