<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>核心引擎测试</title>
    <style>
        body { font-family: monospace; background: #222; color: #eee; padding: 10px; font-size: 12px; }
        h1 { font-size: 1.2em; margin: 0 0 10px 0; }
        
        .layout-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .panel {
            background: #1a1a1a;
            padding: 10px;
            border: 1px solid #444;
            border-radius: 4px;
        }
        
        .panel h3 {
            margin: 0 0 5px 0;
            font-size: 1em;
            border-bottom: 1px solid #333;
            padding-bottom: 2px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: auto auto;
            gap: 5px 15px;
        }

        #console { 
            background: #111; 
            border: 1px solid #444; 
            padding: 5px; 
            height: 200px; 
            overflow-y: auto; 
            font-size: 11px;
        }
        .log-entry { margin: 1px 0; border-bottom: 1px solid #222; }

        .controls-area {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 10px;
            align-items: center;
        }
        
        button { padding: 4px 8px; font-size: 11px; background: #333; color: #fff; border: 1px solid #555; cursor: pointer; }
        button:hover { background: #444; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        input { padding: 4px; background: #333; border: 1px solid #555; color: #fff; font-size: 11px; }
        
        ul { margin: 0; padding: 0; list-style: none; }
        li { margin-bottom: 2px; }
    </style>
</head>
<body>
    <h1>核心引擎测试</h1>
    
    <div class="layout-grid">
        <!-- Player Stats Panel -->
        <div id="playerStats" class="panel" style="display: none;">
            <h3 style="color: #81a5ff;">玩家状态</h3>
            <div class="stats-grid">
                <div>名称: <span id="statName" style="color: #fff; font-weight: bold;">-</span></div>
                <div>HP: <span id="statHp" style="color: #ff8e8e;">-</span> / <span id="statMaxHp">-</span></div>
                <div>AP: <span id="statAp" style="color: #7bffcf;">-</span> / <span id="statMaxAp">-</span></div>
            </div>
        </div>

        <!-- Battle Info Panel -->
        <div id="battleInfo" class="panel" style="display: none;">
            <h3 style="color: #ff8181;">战斗信息</h3>
            <div style="margin-bottom: 5px;">回合: <span id="battleTurn" style="color: #fff; font-weight: bold;">-</span></div>
            <div>敌人列表:</div>
            <ul id="enemyList">
                <!-- Enemies will be injected here -->
            </ul>
            <div style="margin-top: 10px; border-top: 1px solid #333; padding-top: 5px;">
                <div>待释放技能队列:</div>
                <ul id="skillQueue" style="color: #aaa;">
                    <li>(空)</li>
                </ul>
            </div>
        </div>
    </div>

    <div class="controls-area">
        <input type="text" id="username" placeholder="用户名" value="Hero">
        <button id="btnLogin">登录</button>
        <span style="color: #444;">|</span>
        <button id="btnSelectLevel" disabled>选择关卡 1-1</button>
        <span style="color: #444;">|</span>
        <button id="btnAddSkill" disabled>添加技能：斩击 (2 AP)</button>
        <button id="btnCommitTurn" disabled>执行回合</button>
    </div>

    <div id="console"></div>

    <script type="module">
        import Engine from '../script/engine/CoreEngine.js';

        const consoleDiv = document.getElementById('console');
        const btnLogin = document.getElementById('btnLogin');
        const btnSelectLevel = document.getElementById('btnSelectLevel');
        const btnAddSkill = document.getElementById('btnAddSkill');
        const btnCommitTurn = document.getElementById('btnCommitTurn');
        const inputUsername = document.getElementById('username');

        // Stats Elements
        const statPanel = document.getElementById('playerStats');
        const statName = document.getElementById('statName');
        const statHp = document.getElementById('statHp');
        const statMaxHp = document.getElementById('statMaxHp');
        const statAp = document.getElementById('statAp');
        const statMaxAp = document.getElementById('statMaxAp');

        // Battle Info Elements
        const battleInfoPanel = document.getElementById('battleInfo');
        const battleTurn = document.getElementById('battleTurn');
        const enemyList = document.getElementById('enemyList');
        const skillQueueList = document.getElementById('skillQueue');

        function log(msg) {
            const div = document.createElement('div');
            div.className = 'log-entry';
            div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            consoleDiv.appendChild(div);
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        }

        // Subscribe to Engine Events
        Engine.eventBus.on('STATE_CHANGED', (data) => {
            log(`状态变更: ${data.from} -> ${data.to}`);
            updateButtons(data.to);
        });

        Engine.eventBus.on('DATA_UPDATE', (data) => {
            log(`数据更新: 玩家 ${data.name} (HP: ${data.stats.hp}, AP: ${data.stats.ap})`);
            
            // Update Stats Panel
            statPanel.style.display = 'block';
            statName.textContent = data.name;
            statHp.textContent = data.stats.hp;
            statMaxHp.textContent = data.stats.maxHp;
            statAp.textContent = data.stats.ap;
            statMaxAp.textContent = data.stats.maxAp;
        });

        Engine.eventBus.on('BATTLE_START', (data) => {
            log(`战斗开始: ${data.player.name} 对战 ${data.level.enemies.length} 个敌人`);
        });

        Engine.eventBus.on('BATTLE_LOG', (data) => {
            log(`战斗日志: ${data.text}`);
        });

        Engine.eventBus.on('BATTLE_END', (data) => {
            log(`>>> 战斗结束: ${data.victory ? '胜利' : '失败'} <<<`);
            alert(`战斗结束: ${data.victory ? '胜利' : '失败'}`);
        });

        Engine.eventBus.on('BATTLE_UPDATE', (data) => {
            // Update Battle Info Panel
            battleInfoPanel.style.display = 'block';
            battleTurn.textContent = data.turn;
            
            enemyList.innerHTML = '';
            if (data.enemies && data.enemies.length > 0) {
                data.enemies.forEach(enemy => {
                    const li = document.createElement('li');
                    li.style.marginBottom = '5px';
                    li.innerHTML = `<span style="color: #ff8e8e;">${enemy.id}</span> - HP: ${enemy.hp} (Speed: ${enemy.speed})`;
                    enemyList.appendChild(li);
                });
            } else {
                enemyList.innerHTML = '<li>无敌人</li>';
            }

            // Update Skill Queue
            skillQueueList.innerHTML = '';
            if (data.queue && data.queue.length > 0) {
                data.queue.forEach((action, index) => {
                    const li = document.createElement('li');
                    li.innerHTML = `${index + 1}. <span style="color: #7bffcf;">${action.skillId}</span> -> ${action.targetId} <button onclick="window.removeSkill(${index})" style="padding: 0 4px; margin-left: 5px;">x</button>`;
                    skillQueueList.appendChild(li);
                });
            } else {
                skillQueueList.innerHTML = '<li>(空)</li>';
            }

            // Update Buttons based on phase
            const isPlanning = data.phase === 'PLANNING';
            btnAddSkill.disabled = !isPlanning;
            btnCommitTurn.disabled = !isPlanning;
        });

        // Global handler for removing skills (since we inject HTML)
        window.removeSkill = (index) => {
            Engine.input.removeSkillFromQueue(index);
        };

        Engine.eventBus.on('TICK', (dt) => {
            // Too spammy to log every tick
            // log(`Tick: ${dt}`);
        });

        // UI Handlers
        btnLogin.onclick = () => {
            const name = inputUsername.value;
            if(name) Engine.input.login(name);
        };

        btnSelectLevel.onclick = () => {
            Engine.input.selectLevel('level_1_1');
        };

        btnAddSkill.onclick = () => {
            Engine.input.addSkillToQueue('skill_slash', 'goblin_01', 'chest');
        };

        btnCommitTurn.onclick = () => {
            Engine.input.commitTurn();
        };

        function updateButtons(state) {
            btnLogin.disabled = state !== 'LOGIN';
            btnSelectLevel.disabled = state !== 'MAIN_MENU';
            
            // Battle buttons are handled by BATTLE_UPDATE
            if (state !== 'BATTLE_LOOP') {
                btnAddSkill.disabled = true;
                btnCommitTurn.disabled = true;
            }
        }

        log('测试页面已加载。引擎正在初始化...');

    </script>
</body>
</html>
