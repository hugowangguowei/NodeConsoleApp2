<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>核心引擎测试 V2 (Armor & Body Parts)</title>
    <style>
        body { font-family: monospace; background: #222; color: #eee; padding: 10px; font-size: 12px; }
        h1 { font-size: 1.2em; margin: 0 0 10px 0; }
        
        .layout-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .panel {
            background: #1a1a1a;
            padding: 10px;
            border: 1px solid #444;
            border-radius: 4px;
        }
        
        .panel h3 {
            margin: 0 0 5px 0;
            font-size: 1em;
            border-bottom: 1px solid #333;
            padding-bottom: 2px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: auto auto;
            gap: 5px 15px;
        }

        #console { 
            background: #111; 
            border: 1px solid #444; 
            padding: 5px; 
            height: 200px; 
            overflow-y: auto; 
            font-size: 11px;
        }
        .log-entry { margin: 1px 0; border-bottom: 1px solid #222; }

        .controls-area {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 10px;
            align-items: center;
        }
        
        button { padding: 4px 8px; font-size: 11px; background: #333; color: #fff; border: 1px solid #555; cursor: pointer; }
        button:hover { background: #444; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        input { padding: 4px; background: #333; border: 1px solid #555; color: #fff; font-size: 11px; }
        
        ul { margin: 0; padding: 0; list-style: none; }
        li { margin-bottom: 2px; }
    </style>
</head>
<body>
    <h1>核心引擎测试 V2 (Armor & Body Parts)</h1>
    
    <div class="layout-grid">
        <!-- Player Stats Panel -->
        <div id="playerStats" class="panel" style="display: none;">
            <h3 style="color: #81a5ff;">玩家状态</h3>
            <div class="stats-grid">
                <div>名称: <span id="statName" style="color: #fff; font-weight: bold;">-</span></div>
                <div>HP: <span id="statHp" style="color: #ff8e8e;">-</span> / <span id="statMaxHp">-</span></div>
                <div>AP: <span id="statAp" style="color: #7bffcf;">-</span> / <span id="statMaxAp">-</span></div>
            </div>
            <div style="margin-top: 10px; border-top: 1px solid #333; padding-top: 5px;">
                <div>装备:</div>
                <ul id="equipmentList" style="color: #aaa;">
                    <li>-</li>
                </ul>
            </div>
        </div>

        <!-- Battle Info Panel -->
        <div id="battleInfo" class="panel" style="display: none;">
            <h3 style="color: #ff8181;">战斗信息</h3>
            <div style="margin-bottom: 5px;">回合: <span id="battleTurn" style="color: #fff; font-weight: bold;">-</span></div>
            <div>敌人列表:</div>
            <ul id="enemyList">
                <!-- Enemies will be injected here -->
            </ul>
            
            <!-- Targeting Controls -->
            <div style="margin-top: 10px; border-top: 1px solid #333; padding-top: 5px;">
                <div style="margin-bottom: 5px; font-weight: bold; color: #ddd;">目标选择:</div>
                <div style="display: flex; gap: 10px; margin-bottom: 5px;">
                    <select id="targetSelect" style="background: #333; color: #fff; border: 1px solid #555; padding: 2px;">
                        <option value="">-- 选择目标 --</option>
                    </select>
                    <select id="partSelect" style="background: #333; color: #fff; border: 1px solid #555; padding: 2px;">
                        <option value="">-- 选择部位 --</option>
                    </select>
                </div>
            </div>

            <div style="margin-top: 10px; border-top: 1px solid #333; padding-top: 5px;">
                <div>待释放技能队列:</div>
                <ul id="skillQueue" style="color: #aaa;">
                    <li>(空)</li>
                </ul>
            </div>
        </div>

        <!-- DataConfig Test Controls -->
        <div class="panel" style="margin-bottom: 10px;">
            <h3 style="color: #d4ff81;">DataConfig 测试</h3>
            <div class="controls-area">
                <button id="btnSaveGame">保存游戏 (Save)</button>
                <button id="btnLoadGame">读取游戏 (Load)</button>
                <button id="btnShowData">显示 DataConfig</button>
            </div>
            <textarea id="dataConfigOutput" style="width: 100%; height: 160px; box-sizing: border-box; background: #111; color: #aaa; border: 1px solid #444; font-family: monospace; font-size: 12px;" readonly></textarea>
        </div>

        <div id="console"></div>
    </div>

    <div class="controls-area">
        <input type="text" id="username" placeholder="用户名" value="Hero">
        <button id="btnLogin">登录 (Continue)</button>
        <button id="btnNewGame">新游戏 (New Game)</button>
        <span style="color: #444;">|</span>
        <button id="btnSelectLevel" disabled>选择关卡 1-1</button>
        <span style="color: #444;">|</span>
        <div id="skillButtons" style="display: inline-flex; gap: 5px;">
            <!-- Skill buttons generated here -->
            <button id="btnAddSkill" disabled>添加技能：斩击 (2 AP)</button>
        </div>
        <button id="btnCommitTurn" disabled>执行回合</button>
    </div>

    <script type="module">
        import Engine from '../script/engine/CoreEngine.js';

        const consoleDiv = document.getElementById('console');
        const btnLogin = document.getElementById('btnLogin');
        const btnNewGame = document.getElementById('btnNewGame');
        const btnSelectLevel = document.getElementById('btnSelectLevel');
        const btnCommitTurn = document.getElementById('btnCommitTurn');
        const inputUsername = document.getElementById('username');
        const skillButtonsContainer = document.getElementById('skillButtons');

        // DataConfig Controls
        const btnSaveGame = document.getElementById('btnSaveGame');
        const btnLoadGame = document.getElementById('btnLoadGame');
        const btnShowData = document.getElementById('btnShowData');
        const dataConfigOutput = document.getElementById('dataConfigOutput');

        // Stats Elements
        const statPanel = document.getElementById('playerStats');
        const statName = document.getElementById('statName');
        const statHp = document.getElementById('statHp');
        const statMaxHp = document.getElementById('statMaxHp');
        const statAp = document.getElementById('statAp');
        const statMaxAp = document.getElementById('statMaxAp');
        const equipmentList = document.getElementById('equipmentList');

        // Battle Info Elements
        const battleInfoPanel = document.getElementById('battleInfo');
        const battleTurn = document.getElementById('battleTurn');
        const enemyList = document.getElementById('enemyList');
        const skillQueueList = document.getElementById('skillQueue');
        const targetSelect = document.getElementById('targetSelect');
        const partSelect = document.getElementById('partSelect');

        // Add change listener to targetSelect
        targetSelect.onchange = () => {
            updatePartSelect(targetSelect.value);
        };

        function log(msg) {
            const div = document.createElement('div');
            div.className = 'log-entry';
            div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            consoleDiv.appendChild(div);
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        }

        // Subscribe to Engine Events
        Engine.eventBus.on('STATE_CHANGED', (data) => {
            log(`状态变更: ${data.from} -> ${data.to}`);
            updateButtons(data.to);
        });

        // DataConfig Event Handlers
        btnSaveGame.onclick = () => {
            Engine.input.saveGame(); // Use Engine input interface
            log("游戏已保存。");
            updateDataDisplay();
        };

        btnLoadGame.onclick = () => {
            const username = inputUsername.value;
            Engine.input.login(username);
            updateDataDisplay();
        };

        btnShowData.onclick = () => {
            updateDataDisplay();
        };

        function updateDataDisplay() {
            if (Engine.data.dataConfig) {
                dataConfigOutput.value = JSON.stringify(Engine.data.dataConfig, null, 2);
            } else {
                dataConfigOutput.value = "No DataConfig available.";
            }
        }

        Engine.eventBus.on('DATA_UPDATE', (data) => {
            log(`数据更新: 玩家 ${data.name} (HP: ${data.stats.hp}, AP: ${data.stats.ap})`);
            
            // Update Stats Panel
            statPanel.style.display = 'block';
            statName.textContent = data.name;
            statHp.textContent = data.stats.hp;
            statMaxHp.textContent = data.stats.maxHp;
            statAp.textContent = data.stats.ap;
            statMaxAp.textContent = data.stats.maxAp;

            // Update Equipment List
            equipmentList.innerHTML = '';
            if (data.equipment) {
                if (data.equipment.weapon) {
                    const li = document.createElement('li');
                    li.textContent = `Weapon: ${data.equipment.weapon}`;
                    equipmentList.appendChild(li);
                }
                if (data.equipment.armor) {
                    for (const [slot, itemId] of Object.entries(data.equipment.armor)) {
                        if (itemId) {
                            const li = document.createElement('li');
                            li.textContent = `${slot}: ${itemId}`;
                            equipmentList.appendChild(li);
                        }
                    }
                }
            }

            // Generate Skill Buttons if needed
            if (data.skills && skillButtonsContainer.children.length <= 1) { // Check if already generated
                skillButtonsContainer.innerHTML = ''; // Clear default
                data.skills.forEach(skillId => {
                    const skillConfig = Engine.data.getSkillConfig(skillId);
                    if (skillConfig) {
                        const btn = document.createElement('button');
                        btn.textContent = `${skillConfig.name} (${skillConfig.cost} AP)`;
                        btn.onclick = () => {
                            const targetId = targetSelect.value;
                            const bodyPart = partSelect.value;
                            
                            if (!targetId) {
                                alert("请先选择目标！");
                                return;
                            }
                            
                            Engine.input.addSkillToQueue(skillId, targetId, bodyPart || undefined);
                        };
                        btn.disabled = true; // Initially disabled until battle starts
                        btn.dataset.skillBtn = "true";
                        skillButtonsContainer.appendChild(btn);
                    }
                });
            }
        });

        Engine.eventBus.on('BATTLE_START', (data) => {
            log(`战斗开始: ${data.player.name} 对战 ${data.level.enemies.length} 个敌人`);
            updateTargetSelect(data.player, data.level.enemies);
        });

        Engine.eventBus.on('BATTLE_LOG', (data) => {
            log(`战斗日志: ${data.text}`);
        });

        Engine.eventBus.on('BATTLE_END', (data) => {
            log(`>>> 战斗结束: ${data.victory ? '胜利' : '失败'} <<<`);
            alert(`战斗结束: ${data.victory ? '胜利' : '失败'}`);
        });

        Engine.eventBus.on('BATTLE_UPDATE', (data) => {
            // Update Battle Info Panel
            battleInfoPanel.style.display = 'block';
            battleTurn.textContent = data.turn;
            
            enemyList.innerHTML = '';
            
            updateTargetSelect(Engine.data.playerData, data.enemies);

            if (data.enemies && data.enemies.length > 0) {
                data.enemies.forEach(enemy => {
                    const li = document.createElement('li');
                    li.style.marginBottom = '5px';
                    li.innerHTML = `<span style="color: #ff8e8e;">${enemy.id}</span> - HP: ${enemy.hp} (Speed: ${enemy.speed})`;
                    
                    // Show body parts info if available
                    if (enemy.bodyParts) {
                        const partsInfo = document.createElement('div');
                        partsInfo.style.fontSize = '10px';
                        partsInfo.style.color = '#888';
                        partsInfo.style.marginLeft = '10px';
                        
                        let partsText = [];
                        for (const [partName, partData] of Object.entries(enemy.bodyParts)) {
                            partsText.push(`${partName}: ${partData.hp}/${partData.maxHp} (Armor: ${partData.armor})`);
                        }
                        partsInfo.textContent = partsText.join(' | ');
                        li.appendChild(partsInfo);
                    }
                    
                    enemyList.appendChild(li);
                });
            } else {
                enemyList.innerHTML = '<li>无敌人</li>';
            }

            // Update Skill Queue
            skillQueueList.innerHTML = '';
            if (data.queue && data.queue.length > 0) {
                data.queue.forEach((action, index) => {
                    const li = document.createElement('li');
                    li.innerHTML = `${index + 1}. <span style="color: #7bffcf;">${action.skillId}</span> -> ${action.targetId} (${action.bodyPart || 'Global'}) <button onclick="window.removeSkill(${index})" style="padding: 0 4px; margin-left: 5px;">x</button>`;
                    skillQueueList.appendChild(li);
                });
            } else {
                skillQueueList.innerHTML = '<li>(空)</li>';
            }

            // Update Buttons based on phase
            const isPlanning = data.phase === 'PLANNING';
            
            const skillBtns = document.querySelectorAll('[data-skill-btn="true"]');
            skillBtns.forEach(btn => btn.disabled = !isPlanning);

            btnCommitTurn.disabled = !isPlanning;
        });

        function updateTargetSelect(player, enemies) {
            const currentVal = targetSelect.value;
            targetSelect.innerHTML = '<option value="">-- 选择目标 --</option>';
            
            // Add Player
            if (player) {
                const opt = document.createElement('option');
                opt.value = player.id;
                opt.textContent = `${player.name} (Self)`;
                targetSelect.appendChild(opt);
            }
            
            // Add Enemies
            if (enemies) {
                enemies.forEach(e => {
                    if (e.hp > 0) {
                        const opt = document.createElement('option');
                        opt.value = e.id;
                        opt.textContent = `${e.name} (HP: ${e.hp})`;
                        targetSelect.appendChild(opt);
                    }
                });
            }
            
            // Restore selection if valid
            if (currentVal) {
                // Check if still exists
                for (let i = 0; i < targetSelect.options.length; i++) {
                    if (targetSelect.options[i].value === currentVal) {
                        targetSelect.value = currentVal;
                        break;
                    }
                }
            }
            
            // Update parts based on current selection (whether restored or reset)
            updatePartSelect(targetSelect.value);
        }

        function updatePartSelect(targetId) {
            const currentPart = partSelect.value;
            partSelect.innerHTML = '<option value="">-- 选择部位 --</option>';
            
            if (!targetId) return;

            let target = null;
            // Access data via Engine.data which is DataManager instance
            if (Engine.data.playerData && Engine.data.playerData.id === targetId) {
                target = Engine.data.playerData;
            } else if (Engine.data.currentLevelData && Engine.data.currentLevelData.enemies) {
                target = Engine.data.currentLevelData.enemies.find(e => e.id === targetId);
            }

            if (target) {
                if (target.bodyParts) {
                    // Enemy with explicit bodyParts
                    for (const part in target.bodyParts) {
                        const opt = document.createElement('option');
                        opt.value = part;
                        const partData = target.bodyParts[part];
                        opt.textContent = `${part} (HP: ${partData.hp}/${partData.maxHp})`;
                        partSelect.appendChild(opt);
                    }
                } else if (target.equipment && target.equipment.armor) {
                    // Player (using armor slots as body parts)
                    for (const slot in target.equipment.armor) {
                         const opt = document.createElement('option');
                         opt.value = slot;
                         opt.textContent = slot; 
                         partSelect.appendChild(opt);
                    }
                }
            }
            
            // Restore part selection if valid for the new target
            if (currentPart) {
                for (let i = 0; i < partSelect.options.length; i++) {
                    if (partSelect.options[i].value === currentPart) {
                        partSelect.value = currentPart;
                        break;
                    }
                }
            }
        }

        // Global handler for removing skills (since we inject HTML)
        window.removeSkill = (index) => {
            Engine.input.removeSkillFromQueue(index);
        };

        Engine.eventBus.on('TICK', (dt) => {
            // Too spammy to log every tick
            // log(`Tick: ${dt}`);
        });

        // UI Handlers
        btnLogin.onclick = () => {
            const name = inputUsername.value;
            if(name) Engine.input.login(name);
        };

        btnNewGame.onclick = () => {
            const name = inputUsername.value;
            if(name) {
                Engine.resetGame(name);
                updateButtons('MAIN_MENU'); 
            }
        };

        btnSelectLevel.onclick = () => {
            Engine.input.selectLevel('level_1_1');
        };

        btnCommitTurn.onclick = () => {
            Engine.input.commitTurn();
        };

        function updateButtons(state) {
            btnLogin.disabled = state !== 'LOGIN';
            btnSelectLevel.disabled = state !== 'MAIN_MENU';
            
            // Battle buttons are handled by BATTLE_UPDATE
            if (state !== 'BATTLE_LOOP') {
                const skillBtns = document.querySelectorAll('[data-skill-btn="true"]');
                skillBtns.forEach(btn => btn.disabled = true);
                btnCommitTurn.disabled = true;
            }
        }

        log('测试页面 V2 已加载。引擎正在初始化...');

    </script>
</body>
</html>
