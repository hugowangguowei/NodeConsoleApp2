<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>技能编辑器原型</title>
    <!-- Vue is not used in this editor; keep page dependency-free -->
    <link rel="stylesheet" href="../script/editor/skill/skill_editor.css" />
    <link rel="stylesheet" href="./skill_editor_test_v3.css" />
</head>
<body>

<div class="skill-editor-v3">
<div id="app">
    <!-- A. Toolbar -->
    <div id="toolbar">
        <input type="file" id="file-input" accept=".json" style="display: none;" onchange="editor.importJsonFile(this)">
        <button class="btn btn-dark" onclick="editor.loadProjectData()">Load Project Data</button>
        <button class="btn btn-dark" onclick="editor.toggleSkillDrawer()">Skills</button>
        <button class="btn btn-primary" onclick="document.getElementById('file-input').click()">Import skills (v1/v3)</button>
        <button class="btn btn-primary" onclick="editor.createNewSkill()">+ New Skill</button>
        <button class="btn btn-success" onclick="editor.exportJson(true)">Export (dev)
        </button>
        <button class="btn btn-success" onclick="editor.exportJson(false)" style="display:none">Export (runtime)
        </button>
        <button class="btn btn-danger" onclick="editor.clearCanvas()">Clear</button>
        <span style="flex:1"></span>
        <button class="btn btn-dark" onclick="editor.autoLayout()">Auto Layout</button>
    </div>

    <div id="main-container">
        <!-- B. Skill List Drawer (default collapsed) -->
        <div id="skill-drawer-handle" title="Skills"></div>
        <div id="skill-drawer" aria-label="Skill Drawer">
            <div class="panel-header" style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
                <span>技能库</span>
                <button class="btn btn-sm btn-dark" type="button" onclick="editor.toggleSkillDrawer(false)">Close</button>
            </div>
            <div id="skill-drawer-search">
                <input id="skill-search-input" type="text" placeholder="搜索技能：name / id" autocomplete="off" />
                <div class="small" style="margin-top:6px; color:#888;">快捷键：Ctrl+B 展开/收起，Ctrl+K 聚焦搜索</div>
            </div>
            <div id="skill-drawer-content">
                <!-- Library items will be injected here -->
            </div>
        </div>

        <!-- C. Canvas Workspace -->
        <div id="canvas-wrapper">
            <div id="canvas-transform-layer">
                <!-- Layer 1: Grid -->
                <canvas id="grid-layer" width="5000" height="5000"></canvas>
                <!-- Layer 2: Connections -->
                <svg id="connection-layer">
                    <defs>
                        <marker id="arrowhead" markerWidth="10" markerHeight="7" 
                        refX="9" refY="3.5" orient="auto">
                          <polygon points="0 0, 10 3.5, 0 7" fill="#666" />
                        </marker>
                    </defs>
                    <!-- Lines will be injected here -->
                </svg>
                <!-- Layer 3: Nodes -->
                <div id="node-layer">
                    <!-- Nodes will be injected here -->
                </div>
            </div>
            <div class="debug-info">平移: 拖拽空白处 | 缩放: 滚轮</div>
        </div>

        <!-- D. Properties Panel -->
        <div id="properties-panel">
            <div class="panel-title">
                <div>Skill Properties</div>
                <div class="small" id="prop-validate-summary">No selection</div>
            </div>
            <div class="panel-scroll" id="prop-content">
                <div class="panel">
                    <div class="panel-h">
                        <span>Summary</span>
                        <span id="prop-summary-badge" class="badge">—</span>
                    </div>
                    <div class="small" id="prop-summary-text">Select a node to edit...</div>
                    <div style="margin-top:10px; display:flex; gap:8px;">
                        <button class="btn btn-primary" style="flex:1" onclick="editor.duplicateCurrentNode()" id="btn-dup" disabled>Duplicate</button>
                        <button class="btn btn-danger" style="flex:1" onclick="editor.deleteCurrentNode()" id="btn-del" disabled>Delete</button>
                    </div>
                </div>

                <div class="panel">
                    <div class="panel-h">A. Basic</div>
                    <div class="grid2">
                        <div class="small">id</div>
                        <input class="input" type="text" id="prop-id" readonly>

                        <div class="small">name</div>
                        <input class="input" type="text" id="prop-name">

                        <div class="small">rarity</div>
                        <select class="select" id="prop-rarity">
                            <option value="Common">Common</option>
                            <option value="Uncommon">Uncommon</option>
                            <option value="Rare">Rare</option>
                            <option value="Epic">Epic</option>
                            <option value="Legendary">Legendary</option>
                        </select>
                    </div>
                    <div style="margin-top:10px;">
                        <div class="small" style="margin-bottom:6px;">description</div>
                        <textarea class="textarea" id="prop-desc"></textarea>
                    </div>
                    <div class="error" id="err-id" style="display:none; margin-top:8px;"></div>
                </div>

                <div class="panel">
                    <div class="panel-h">B. Tree (Editor Meta)</div>
                    <div class="grid2">
                        <div class="small">editorMeta.x</div>
                        <input class="input" type="number" id="meta-x" readonly>

                        <div class="small">editorMeta.y</div>
                        <input class="input" type="number" id="meta-y" readonly>

                        <div class="small">editorMeta.group</div>
                        <input class="input" type="text" id="meta-group" placeholder="e.g. melee" disabled>

                        <div class="small">editorMeta.locked</div>
                        <select class="select" id="meta-locked" disabled>
                            <option value="false">false</option>
                            <option value="true">true</option>
                        </select>
                    </div>
                </div>

                <div class="panel">
                    <div class="panel-h">C. Prerequisites</div>
                    <div class="small" id="prop-prerequisites">—</div>
                </div>

                <div class="panel">
                    <div class="panel-h">D. Unlock (JSON)</div>
                    <div class="small" style="margin-bottom:6px;">`unlock` 推荐结构化编辑；MVP 使用 JSON。</div>
                    <textarea class="textarea" id="prop-unlock" placeholder="{\n  \"cost\": { \"kp\": 1 },\n  \"requirements\": {},\n  \"exclusives\": [],\n  \"grants\": { \"type\": \"permanent\" }\n}"></textarea>
                    <div class="error" id="err-unlock" style="display:none; margin-top:8px;"></div>
                </div>

                <div class="panel">
                    <div class="panel-h">E. Target & Speed</div>
                    <div class="grid2">
                        <div class="small">speed</div>
                        <input class="input" type="number" id="prop-speed">

                        <div class="small">target.subject</div>
                        <select class="select" id="prop-target-subject"></select>

                        <div class="small">target.scope</div>
                        <select class="select" id="prop-target-scope"></select>

                        <div class="small">selection.mode</div>
                        <select class="select" id="prop-target-mode"></select>

                        <div class="small">selection.selectCount</div>
                        <input class="input" type="number" id="prop-target-selectCount" min="1">

                        <div class="small">candidateParts</div>
                        <div style="position:relative;">
                            <button type="button" class="btn btn-dark btn-sm" id="candidatePartsBtn" style="width:100%; text-align:left;">(none)</button>
                            <div id="candidatePartsDropdown" class="panel" style="position:absolute; top:36px; left:0; right:0; z-index:999; display:none; padding:10px;">
                                <div class="small" style="margin-bottom:8px;">选择候选部位（candidateParts）</div>
                                <div id="candidatePartsList"></div>
                                <div style="margin-top:10px; display:flex; gap:8px;">
                                    <button type="button" class="btn btn-sm btn-dark" id="candidatePartsAll">All</button>
                                    <button type="button" class="btn btn-sm btn-dark" id="candidatePartsNone">None</button>
                                    <span style="flex:1"></span>
                                    <button type="button" class="btn btn-sm btn-primary" id="candidatePartsClose">OK</button>
                                </div>
                            </div>
                        </div>

                        <div class="small">selectedParts</div>
                        <div style="position:relative;">
                            <button type="button" class="btn btn-dark btn-sm" id="selectedPartsBtn" style="width:100%; text-align:left;">(none)</button>
                            <div id="selectedPartsDropdown" class="panel" style="position:absolute; top:36px; left:0; right:0; z-index:999; display:none; padding:10px;">
                                <div class="small" style="margin-bottom:8px;">选择已选部位（selectedParts）</div>
                                <div id="selectedPartsList"></div>
                                <div style="margin-top:10px; display:flex; gap:8px;">
                                    <button type="button" class="btn btn-sm btn-dark" id="selectedPartsAll">All</button>
                                    <button type="button" class="btn btn-sm btn-dark" id="selectedPartsNone">None</button>
                                    <span style="flex:1"></span>
                                    <button type="button" class="btn btn-sm btn-primary" id="selectedPartsClose">OK</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="error" id="err-target" style="display:none; margin-top:8px;"></div>
                </div>

                <div class="panel">
                    <div class="panel-h">F. Costs</div>
                    <div class="grid2">
                        <div class="small">costs.ap</div>
                        <input class="input" type="number" id="prop-costs-ap" min="0">

                        <div class="small">costs.perTurnLimit</div>
                        <input class="input" type="number" id="prop-costs-perTurnLimit" min="1">

                        <div class="small">costs.partSlot.part</div>
                        <select class="select" id="prop-costs-part"></select>

                        <div class="small">costs.partSlot.slotCost</div>
                        <input class="input" type="number" id="prop-costs-slotCost" min="0">
                    </div>
                    <div class="error" id="err-costs" style="display:none; margin-top:8px;"></div>
                </div>

                <div class="panel">
                    <div class="panel-h">G. Requirements (JSON)</div>
                    <div class="small" style="margin-bottom:6px;">`requirements` 前期使用 JSON（后续可表单化）。</div>
                    <textarea class="textarea" id="prop-requirements" placeholder="{}"></textarea>
                    <div class="error" id="err-req" style="display:none; margin-top:8px;"></div>
                </div>

                <div class="panel">
                    <div class="panel-h">
                        <span>H. Actions</span>
                        <div class="row-actions">
                            <button class="btn btn-sm btn-dark" type="button" onclick="editor.addActionRow()" id="btn-add-action" disabled>+ Action</button>
                            <button class="btn btn-sm btn-dark" type="button" onclick="editor.openActionsJsonSync()" id="btn-open-actions-json" disabled>JSON</button>
                        </div>
                    </div>
                    <div class="small" style="margin-bottom:10px;">
                        v4：技能使用 `actions[]`。每个 action 拥有独立 `target`，以及单个 `effect`（多效果通过多个 action 表达）。
                    </div>

                    <div id="actions-editor" class="panel" style="padding:10px; background:#fafafa;">
                        <div id="actions-list" class="small" style="color:#888;">(no actions)</div>
                    </div>

                    <div id="actions-json-wrap" class="panel" style="margin-top:10px; display:none; padding:10px;">
                        <div class="small" style="margin-bottom:6px;">高级 JSON（整段 actions[]）。点击 Apply 后才会写回。</div>
                        <textarea class="textarea" id="prop-actions" placeholder="[]"></textarea>
                        <div style="margin-top:8px; display:flex; gap:8px; align-items:center;">
                            <button class="btn btn-dark btn-sm" type="button" onclick="editor.applyActionsJsonToForm()" id="btn-apply-actions-json" disabled>Apply JSON</button>
                            <button class="btn btn-dark btn-sm" type="button" onclick="editor.closeActionsJsonSync()" id="btn-close-actions-json" disabled>Close</button>
                            <span style="flex:1"></span>
                            <button class="btn btn-primary btn-sm" type="button" onclick="editor.validateActionsFromForm()" id="btn-validate-actions" disabled>Validate</button>
                        </div>
                    </div>

                    <div style="margin-top:10px; display:flex; gap:8px; align-items:center;">
                        <button class="btn btn-dark btn-sm" type="button" onclick="editor.saveActionsFromForm()" id="btn-save-actions" disabled>Save Actions</button>
                        <div class="small" id="actions-save-hint" style="color:#888;">actions 采用显式保存（避免中间态破坏数据）</div>
                    </div>
                    <div class="error" id="err-actions" style="display:none; margin-top:8px;"></div>
                </div>

                <div class="panel">
                    <div class="panel-h">
                        <span>I. Buff Refs</span>
                        <button class="btn btn-sm btn-dark" onclick="editor.addBuffRefRow('apply')" id="btn-add-apply" disabled>+ apply</button>
                    </div>
                    <div class="small" style="margin-bottom:8px;">编辑 `buffRefs.apply/remove`。apply 通过 target 区分 self/enemy；buff 从 `buffs.json` 按 name 搜索选择（保存为 buffId）。</div>

                    <div class="small" style="font-weight:700; margin:8px 0 4px;">apply (enemy)</div>
                    <table class="table" id="table-apply">
                        <thead>
                            <tr>
                                <th>buff</th><th>target</th><th>chance</th><th>duration</th><th>stacks</th><th></th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>

                    <div class="small" style="font-weight:700; margin:12px 0 4px;">remove</div>
                    <button class="btn btn-sm btn-dark" onclick="editor.addBuffRefRow('remove')" id="btn-add-remove" disabled>+ remove</button>
                    <table class="table" id="table-remove" style="margin-top:6px;">
                        <thead>
                            <tr>
                                <th>buff</th><th>target</th><th></th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                    <div class="error" id="err-buffs" style="display:none; margin-top:8px;"></div>
                </div>

                <div class="panel">
                    <div class="panel-h">J. Tags</div>
                    <div class="small" style="margin-bottom:6px;">`tags[]` 与 `tagMeta`（用于平衡统计与校验）。</div>

                    <div class="panel" style="padding:10px; background:#fafafa; margin-bottom:10px;">
                        <div class="grid2" style="align-items:center;">
                            <div class="small">Tag Search</div>
                            <input class="input" type="text" id="tags-search" placeholder="filter tags..." autocomplete="off" />
                        </div>
                        <div style="margin-top:8px; display:flex; gap:8px; align-items:center;">
                            <button class="btn btn-sm btn-dark" type="button" onclick="editor.tagsSelectAllFiltered?.()">All (filtered)</button>
                            <button class="btn btn-sm btn-dark" type="button" onclick="editor.tagsSelectNoneFiltered?.()">None (filtered)</button>
                            <span style="flex:1"></span>
                            <div class="small" style="color:#888;">交互选中会自动写回 tags JSON</div>
                        </div>
                        <div id="tags-editor" style="margin-top:10px;"></div>
                    </div>

                    <textarea class="textarea" id="prop-tags" placeholder="[]"></textarea>
                    <div class="small" style="margin:10px 0 6px;">tagMeta (JSON)</div>
                    <textarea class="textarea" id="prop-tagMeta" placeholder="{}"></textarea>
                    <div class="error" id="err-tags" style="display:none; margin-top:8px;"></div>
                </div>

                <div class="panel">
                    <button class="btn btn-success" style="width:100%;" onclick="editor.saveCurrentNode()" id="btn-save" disabled>Save Changes</button>
                </div>
            </div>
        </div>
    </div>
</div>

</div>

<script type="module" src="../script/editor/skill/bootstrap.js"></script>
</body>
</html>
